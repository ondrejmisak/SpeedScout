<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Race Timer Application</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

  body {
    margin: 0;
    font-family: 'Roboto Mono', monospace;
    background: #ffffff;
    color: #00574a;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 1rem 0 4rem;
  }

  h1 {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 2.5rem;
    text-align: center;
    color: #b5b319;
    letter-spacing: 0.1em;
  }

  .main-timer-container {
    background: #f1f5f1;
    border-radius: 12px;
    padding: 1rem 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 10px rgba(0, 87, 74, 0.2);
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 1.2rem;
  }

  label {
    font-size: 1.1rem;
    margin-right: 0.6rem;
    color: #00574a;
    font-weight: 600;
  }

  input[type="time"] {
    font-family: 'Roboto Mono', monospace;
    font-size: 1.3rem;
    padding: 0.2rem 0.5rem;
    border-radius: 6px;
    border: 2px solid #b5b319;
    outline: none;
    width: 120px;
    text-align: center;
    background-color: #ffffff;
    color: #00574a;
    transition: border-color 0.3s ease;
  }
  input[type="time"]:focus {
    border-color: #00574a;
  }
  input[type="time"]::-webkit-clear-button,
  input[type="time"]::-webkit-inner-spin-button {
    display: none;
  }

  button.control-btn, button.team-add-remove-btn {
    background-color: #b5b319;
    border: none;
    border-radius: 8px;
    padding: 0.55rem 1.4rem;
    font-size: 1.15rem;
    font-weight: 700;
    cursor: pointer;
    color: #ffffff;
    box-shadow: 0 4px 10px rgba(181, 179, 25, 0.6);
    transition: background-color 0.3s ease, color 0.3s ease;
    user-select: none;
  }
  button.control-btn:disabled, button.team-add-remove-btn:disabled {
    background-color: #a4a32b;
    cursor: default;
    box-shadow: none;
  }
  button.control-btn:hover:not(:disabled), button.team-add-remove-btn:hover:not(:disabled) {
    background-color: #7f7c17;
  }

  #mainTimerDisplay {
    font-size: 3.3rem;
    font-weight: 800;
    color: #00574a;
    width: 180px;
    text-align: center;
    user-select: none;
    letter-spacing: 0.05em;
  }

  .teams-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem 1.6rem;
    width: 95vw;
    max-width: 1400px;
  }

  .team-column {
    background: #ffffff;
    border: 2px solid #b5b319;
    border-radius: 12px;
    padding: 1rem 1rem 1.2rem;
    box-shadow: 0 4px 14px rgba(0, 87, 74, 0.15);
    display: flex;
    flex-direction: column;
    user-select: none;
    transition: border-color 0.3s ease;
  }
  .team-column:hover {
    border-color: #00574a;
    box-shadow: 0 0 15px rgba(0, 87, 74, 0.35);
  }

  .team-header-input {
    width: 100%;
    font-size: 1.5rem;
    font-weight: 700;
    border: 2px solid #b5b319;
    border-radius: 6px;
    padding: 0.25rem 0.6rem;
    text-align: center;
    background-color: #f9fbe7;
    color: #00574a;
    box-shadow: inset 0 2px 4px rgba(181, 179, 25, 0.3);
    user-select: text;
    transition: border-color 0.25s ease, background-color 0.3s ease;
  }
  .team-header-input:focus {
    outline: none;
    background-color: #e6f2ee;
    border-color: #00574a;
    box-shadow: 0 0 6px #00574a;
  }

  .pit-controls {
    display: flex;
    justify-content: center;
    gap: 0.8rem;
    margin: 1rem 0 1rem;
  }

  button.pit-btn {
    flex: 1 1 40%;
    background-color: #b5b319;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 0;
    font-weight: 700;
    font-size: 1.05rem;
    color: #ffffff;
    box-shadow: 0 3px 12px rgba(181, 179, 25, 0.7);
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button.pit-btn:disabled {
    background-color: #a4a32b;
    cursor: default;
    box-shadow: none;
  }
  button.pit-btn:hover:not(:disabled) {
    background-color: #7f7c17;
  }

  .pit-timer {
    font-family: 'Roboto Mono', monospace;
    font-size: 1.7rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 0.8rem;
    color: #00574a;
    user-select: none;
  }

  .pit-times-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 8px;
    min-height: 36px;
    justify-content: center;
    margin-bottom: 0.7rem;
  }

  .pit-time-strip {
    background: #00574a;
    color: #b5b319;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 0.95rem;
    box-shadow: 0 0 10px #00574aaa;
    min-width: 38px;
    text-align: center;
    user-select: none;
  }

  .rider-timer {
    font-family: 'Roboto Mono', monospace;
    font-size: 2rem;
    font-weight: 800;
    color: #b5b319;
    text-align: center;
    margin-top: 0;
    margin-bottom: 0.8rem;
    user-select: text;
    letter-spacing: 0.03em;
  }

  .times-history {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.85rem;
    color: #00574a;
    line-height: 1.3;
    max-height: 90px;
    overflow-y: auto;
    margin-top: 0.1rem;
    margin-bottom: 0.6rem;
    padding-left: 18px;
    border-left: 3px solid #b5b319;
  }

  .times-history-title {
    font-weight: 700;
    color: #b5b319;
    margin: 0 0 0.3rem 0;
    font-size: 0.9rem;
    user-select: none;
  }

  /* Container for add/remove buttons */
  .team-add-remove-container {
    margin-bottom: 1rem;
    display: flex;
    gap: 1rem;
  }

  button.team-add-remove-btn {
    min-width: 100px;
  }

  @media (max-width: 720px) {
    .teams-container {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  }
</style>
</head>
<body>
  <h1>Race Timer Application</h1>
  <div class="main-timer-container" role="region" aria-label="Main Race Timer Controls">
    <label for="raceTimeInput">Set Race Time (HH:MM:SS):</label>
    <input type="time" id="raceTimeInput" step="1" value="01:00:00" />
    <div id="mainTimerDisplay" aria-live="polite" aria-atomic="true">01:00:00</div>
    <button class="control-btn" id="btnStart">Start</button>
    <button class="control-btn" id="btnPause" disabled>Pause</button>
    <button class="control-btn" id="btnReset" disabled>Reset</button>
  </div>

  <div class="team-add-remove-container" aria-label="Add or Remove Teams Controls">
    <button class="team-add-remove-btn" id="btnAddTeam" aria-disabled="false" aria-label="Add Team">Add Team</button>
    <button class="team-add-remove-btn" id="btnRemoveTeam" aria-disabled="true" aria-label="Remove Team">Remove Team</button>
  </div>

  <div class="teams-container" role="region" aria-label="Teams Timers">
    <!-- Teams columns injected by JS -->
  </div>

<script>
  (() => {
    const MAX_TEAMS = 10;
    const MIN_TEAMS = 1;

    const raceTimeInput = document.getElementById('raceTimeInput');
    const mainTimerDisplay = document.getElementById('mainTimerDisplay');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnReset = document.getElementById('btnReset');
    const btnAddTeam = document.getElementById('btnAddTeam');
    const btnRemoveTeam = document.getElementById('btnRemoveTeam');

    const teamsContainer = document.querySelector('.teams-container');

    function formatTimeMs(ms) {
      const h = Math.floor(ms / 3600000);
      const m = Math.floor((ms % 3600000) / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const cs = Math.floor((ms % 1000) / 10);
      return (
        (h > 0 ? h.toString().padStart(2,'0') + ':' : '') +
        m.toString().padStart(2,'0') + ':' +
        s.toString().padStart(2,'0') + '.' +
        cs.toString().padStart(2,'0')
      );
    }

    function parseRaceTimeInput(val) {
      const parts = val.split(':');
      if(parts.length === 3){
        const [h,m,s] = parts.map(x => parseInt(x,10));
        if ([h,m,s].some(isNaN)) return null;
        return (h*3600 + m*60 + s)*1000;
      }
      return null;
    }

    function formatHHMMSS(ms){
      let s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      s -= h*3600;
      const m = Math.floor(s/60);
      s -= m*60;
      return [h,m,s].map(v => v.toString().padStart(2,'0')).join(':');
    }

    let raceDurationMs = parseRaceTimeInput(raceTimeInput.value) || 3600000;
    let raceRemainingMs = raceDurationMs;
    let raceInterval = null;
    let raceRunning = false;
    const startTimestamp = { value: null };

    class Team {
      constructor(id) {
        this.id = id;
        this.pitIntervals = [];
        this.pitRunning = false;
        this.pitStartTime = 0;
        this.riderStartTimestamp = null;
        this.lastRaceElapsed = 0;
        this.el = this.createTeamColumn();
        this.bindPitButtons();
      }
      createTeamColumn() {
        const col = document.createElement('section');
        col.className = 'team-column';
        col.setAttribute('aria-label', `Team ${this.id + 1}`);

        this.headerInput = document.createElement('input');
        this.headerInput.type = 'text';
        this.headerInput.value = `Team ${this.id + 1}`;
        this.headerInput.className = 'team-header-input';
        this.headerInput.setAttribute('aria-label', `Team ${this.id + 1} Name`);
        col.appendChild(this.headerInput);

        const pitControls = document.createElement('div');
        pitControls.className = 'pit-controls';

        this.btnPitIn = document.createElement('button');
        this.btnPitIn.className = 'pit-btn';
        this.btnPitIn.textContent = 'IN';
        this.btnPitIn.setAttribute('aria-pressed', 'false');

        this.btnPitOut = document.createElement('button');
        this.btnPitOut.className = 'pit-btn';
        this.btnPitOut.textContent = 'OUT';
        this.btnPitOut.disabled = true;

        pitControls.appendChild(this.btnPitIn);
        pitControls.appendChild(this.btnPitOut);
        col.appendChild(pitControls);

        this.pitTimerDisplay = document.createElement('div');
        this.pitTimerDisplay.className = 'pit-timer';
        this.pitTimerDisplay.textContent = '00:00.00';
        col.appendChild(this.pitTimerDisplay);

        this.pitTimesList = document.createElement('div');
        this.pitTimesList.className = 'pit-times-list';
        col.appendChild(this.pitTimesList);

        this.riderTimerDisplay = document.createElement('p');
        this.riderTimerDisplay.className = 'rider-timer';
        this.riderTimerDisplay.textContent = '00:00.00';
        col.appendChild(this.riderTimerDisplay);

        const pitHistoryTitle = document.createElement('p');
        pitHistoryTitle.className = 'times-history-title';
        pitHistoryTitle.textContent = 'Pit times history';
        col.appendChild(pitHistoryTitle);

        this.pitTimesHistory = document.createElement('ul');
        this.pitTimesHistory.className = 'times-history';
        col.appendChild(this.pitTimesHistory);

        const riderHistoryTitle = document.createElement('p');
        riderHistoryTitle.className = 'times-history-title';
        riderHistoryTitle.textContent = 'Rider times history';
        col.appendChild(riderHistoryTitle);

        this.riderTimesHistory = document.createElement('ul');
        this.riderTimesHistory.className = 'times-history';
        col.appendChild(this.riderTimesHistory);

        teamsContainer.appendChild(col);
        return col;
      }
      bindPitButtons() {
        this.btnPitIn.addEventListener('click', () => {
          if (!raceRunning) return;
          if (!this.pitRunning) {
            this.startPit();
            updateAddRemoveButtons(); // update add/remove buttons in case
          }
        });
        this.btnPitOut.addEventListener('click', () => {
          if (!raceRunning) return;
          if (this.pitRunning) {
            this.stopPit();
            updateAddRemoveButtons();
          }
        });
      }
      updatePitTimerDisplay(elapsedMs) {
        this.pitTimerDisplay.textContent = formatTimeMs(elapsedMs);
      }
      addPitIntervalStrip(durationMs) {
        const strip = document.createElement('div');
        strip.className = 'pit-time-strip';
        const count = this.pitIntervals.length;
        strip.title = `Pitstop #${count}`;
        strip.textContent = count;
        this.pitTimesList.appendChild(strip);
      }
      startPit() {
        this.pitRunning = true;
        this.pitStartTime = currentRaceElapsedMs();
        this.btnPitIn.disabled = true;
        this.btnPitIn.setAttribute('aria-pressed','true');
        this.btnPitOut.disabled = false;
        this.riderStartTimestamp = null;
        this.updatePitTimerDisplay(0);
      }
      stopPit() {
        if (!this.pitRunning) return;
        this.pitRunning = false;
        const pitEndTime = currentRaceElapsedMs();
        const pitDuration = pitEndTime - this.pitStartTime;
        this.pitIntervals.push({start: this.pitStartTime, end: pitEndTime, durationMs: pitDuration});
        this.addPitIntervalStrip(pitDuration);
        this.updatePitTimerDisplay(pitDuration);
        this.btnPitIn.disabled = false;
        this.btnPitIn.setAttribute('aria-pressed','false');
        this.btnPitOut.disabled = true;

        let riderElapsedTime = 0;
        if(this.riderStartTimestamp !== null){
          riderElapsedTime = this.pitStartTime - this.riderStartTimestamp;
        }

        const pitItem = document.createElement('li');
        pitItem.textContent = formatTimeMs(pitDuration);
        this.pitTimesHistory.appendChild(pitItem);

        const riderItem = document.createElement('li');
        riderItem.textContent = formatTimeMs(riderElapsedTime);
        this.riderTimesHistory.appendChild(riderItem);

        this.riderStartTimestamp = currentRaceElapsedMs();
        this.riderTimerDisplay.textContent = '00:00.00';
      }
      updateTimers(raceElapsedMs) {
        if (this.pitRunning) {
          const pitElapsed = raceElapsedMs - this.pitStartTime;
          this.updatePitTimerDisplay(pitElapsed);
          if(this.riderStartTimestamp === null){
            this.riderTimerDisplay.textContent = '00:00.00';
          }
        } else {
          if (this.pitIntervals.length > 0) {
            const lastPit = this.pitIntervals[this.pitIntervals.length -1];
            this.updatePitTimerDisplay(lastPit.durationMs);
          } else {
            this.updatePitTimerDisplay(0);
          }
          if (this.riderStartTimestamp !== null) {
            const riderElapsed = raceElapsedMs - this.riderStartTimestamp;
            this.riderTimerDisplay.textContent = formatTimeMs(riderElapsed);
          } else {
            this.riderTimerDisplay.textContent = '00:00.00';
          }
        }
      }
      reset() {
        this.pitIntervals = [];
        this.pitRunning = false;
        this.pitStartTime = 0;
        this.riderStartTimestamp = null;
        this.lastRaceElapsed = 0;
        this.pitTimerDisplay.textContent = '00:00.00';
        this.riderTimerDisplay.textContent = '00:00.00';
        this.btnPitIn.disabled = false;
        this.btnPitIn.setAttribute('aria-pressed','false');
        this.btnPitOut.disabled = true;
        this.pitTimesList.innerHTML = '';
        this.pitTimesHistory.innerHTML = '';
        this.riderTimesHistory.innerHTML = '';
      }
      destroy() {
        // Remove DOM
        this.el.remove();
      }
    }

    let teams = [];

    function addTeam() {
      if (teams.length >= MAX_TEAMS) return;
      const newId = teams.length > 0 ? teams[teams.length - 1].id + 1 : 0;
      const team = new Team(newId);
      teams.push(team);
      updateAddRemoveButtons();
    }

    function removeTeam() {
      if (teams.length <= MIN_TEAMS) return;
      const removed = teams.pop();
      removed.destroy();
      updateAddRemoveButtons();
    }

    function updateAddRemoveButtons() {
      btnAddTeam.disabled = teams.length >= MAX_TEAMS || raceRunning;
      btnRemoveTeam.disabled = teams.length <= MIN_TEAMS || raceRunning;
      btnAddTeam.setAttribute('aria-disabled', btnAddTeam.disabled.toString());
      btnRemoveTeam.setAttribute('aria-disabled', btnRemoveTeam.disabled.toString());
    }

    function currentRaceElapsedMs() {
      return raceDurationMs - raceRemainingMs;
    }

    function updateMainTimer() {
      const display = formatHHMMSS(raceRemainingMs);
      mainTimerDisplay.textContent = display;
      mainTimerDisplay.setAttribute('aria-label', `Main race timer: ${display}`);
    }

    function tick() {
      const now = Date.now();
      const elapsedSinceStart = now - startTimestamp.value;
      let newRemaining = raceDurationMs - elapsedSinceStart;
      if(newRemaining < 0) newRemaining = 0;
      raceRemainingMs = newRemaining;

      updateMainTimer();

      const raceElapsed = currentRaceElapsedMs();
      teams.forEach(team => {
        team.updateTimers(raceElapsed);
      });

      if(raceRemainingMs === 0){
        stopTimer();
      }
    }

    function startTimer() {
      if(raceRunning) return;
      if(raceRemainingMs === 0){
        raceRemainingMs = raceDurationMs;
        teams.forEach(team => team.reset());
      }
      startTimestamp.value = Date.now() - (raceDurationMs - raceRemainingMs);
      raceInterval = setInterval(tick, 50);
      raceRunning = true;

      btnStart.disabled = true;
      btnPause.disabled = false;
      btnReset.disabled = false;
      raceTimeInput.disabled = true;

      const raceElapsed = currentRaceElapsedMs();
      teams.forEach(team => {
        if (!team.pitRunning) {
          team.riderStartTimestamp = raceElapsed;
          team.btnPitIn.disabled = false;
          team.btnPitOut.disabled = true;
        } else {
          team.btnPitIn.disabled = true;
          team.btnPitOut.disabled = false;
          team.riderStartTimestamp = null;
        }
      });

      updateAddRemoveButtons();
    }

    function pauseTimer() {
      if(!raceRunning) return;
      clearInterval(raceInterval);
      raceInterval = null;
      raceRunning = false;
      btnStart.disabled = false;
      btnPause.disabled = true;
      btnReset.disabled = false;
      raceTimeInput.disabled = true;
      teams.forEach(team => {
        team.btnPitIn.disabled = true;
        team.btnPitOut.disabled = true;
      });
      updateAddRemoveButtons();
    }

    function resetTimer() {
      clearInterval(raceInterval);
      raceInterval = null;
      raceRunning = false;
      raceRemainingMs = raceDurationMs;
      updateMainTimer();
      teams.forEach(team => team.reset());
      btnStart.disabled = false;
      btnPause.disabled = true;
      btnReset.disabled = true;
      raceTimeInput.disabled = false;
      updateAddRemoveButtons();
    }

    function stopTimer() {
      clearInterval(raceInterval);
      raceInterval = null;
      raceRunning = false;
      btnStart.disabled = true;
      btnPause.disabled = true;
      btnReset.disabled = false;
      raceTimeInput.disabled = true;
      teams.forEach(team => {
        team.btnPitIn.disabled = true;
        team.btnPitOut.disabled = true;
      });
      updateAddRemoveButtons();
    }

    btnStart.addEventListener('click', startTimer);
    btnPause.addEventListener('click', pauseTimer);
    btnReset.addEventListener('click', resetTimer);
    btnAddTeam.addEventListener('click', addTeam);
    btnRemoveTeam.addEventListener('click', removeTeam);

    function initTeams() {
      for(let i=0; i<10; i++){
        addTeam();
      }
    }

    initTeams();
    updateMainTimer();
    updateAddRemoveButtons();
  })();
</script>
</body>
</html>

